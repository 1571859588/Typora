# 3.1 云数据库上手

| 名称 | 作用                   |
| ---- | ---------------------- |
| 集合 | 数据库中多个记录的集合 |
| 文档 | 数据库中的一条记录     |
| 字段 | 数据库中特定记录的值   |

# 3.2 数据迁移

* 仅支持导入CSV、JSON格式的文件数据
* 有云开发控制台和HTTP API两种导入方式

## Excel文件转为CSV文件

用excel另存为csv-utf8格式(数据库只支持utf-8编码)

## Excel文件转为JSON文件

### 手动版（实现简单，但对于大量数据修改复杂）

网站：http://www.bejson.com/json/col2json/
在线转换的结果每条JSON记录最后都没有逗号分割，需要自行用文本替换把逗号去掉

### 自动版（编写代码复杂，暂时不讲）

## 注意

1. 各个记录对象之间使用\n分割，而非逗号
2. JSON数据每个键值对的键名首尾不能是“.”，例如“.a”，“abc.”，且不能包含多个连续的“.”，例如“a..b”
3. 键名不能重复，且不能有歧义。例如{"a":1,"a":2}或{"a":{"b":1},"a.b":2}
4. 时间格式须为ISODate格式，如"date":{"$date":"2018-08-31T17:30:00.882Z"}
5. 当使用Insert冲突处理模式时，同一文件不能存在重复的_id字段，或与数据库已有记录相同的_id字段
6. CSV格式的数据默认以第一行作为导入后的所有键名，余下的每一行则是与首行键名一一对应的键值记录

# 3.3 基础概念

## 数据类型

* string 字符串
* number 数字
* object 对象
* array 数组
* bool 布尔值
* date 时间
  * 精确到毫秒，可以在微信小程序端使用JS内置Date对象创建。
    * 但是创建的是客户端时间，不是服务器端时间，会不一致
      * 若需要吻合，那么就要用API的serverDate对象创建
* geo 多种地理位置类型
* null 占位符，表示一个字段存在但值为空

## 索引管理

* 唯一性索引会要求被索引的集合不能存在被索引字段值都相同的两个记录
* 若记录中不存在某个字段，则对索引字段来说其值默认为null，若索引有唯一性限制，则不允许存在两个或以上的该字段为空/不存在该字段的记录。

## 权限控制

### 管理端

运行在云函数上，拥有所有读写数据库的权限

#### 云函数端

#### 云控制台

权限同管理端，拥有所有权限

### 微信小程序端

运行在微信小程序中，读写数据库受权限控制限制

### 注意

新建集合的默认权限是：仅创建者可读写，若是非创建者在微信小程序端是无法读取集合数据的。有些读者的数据是通过云开发控制台导入的，没有对集合的权限进行修改（默认权限是仅创建者可读写），就会出现在微信小程序读取不到集合数据的情况。

# 3.4 云数据库API列表

## 请求

请求表示链式调用终结

### 触发网络请求的API

| API    | 说明                       |
| ------ | -------------------------- |
| get    | 获取集合/记录数据          |
| add    | 在集合上新增记录           |
| update | 更新集合/记录数据          |
| set    | 替换更新一个记录           |
| remove | 删除记录                   |
| count  | 统计查询语句对应的记录条数 |

## 引用

获取引用的API

| API        | 说明                                   |
| ---------- | -------------------------------------- |
| database   | 获取数据库引用，返回Database对象       |
| collection | 获取集合引用，返回Collection对象       |
| doc        | 获取对一个记录的引用，返回Document对象 |

## 数据库

数据库对象的字段

| 字段       | 说明                                  |
| ---------- | ------------------------------------- |
| command    | 获取数据库查询及更新指令，返回Command |
| serverDate | 构造服务端时间                        |
| Geo        | 获取地理位置操作对象，返回Geo对象     |

## 集合

集合对象API

| API     | 说明                                                                |
| ------- | ------------------------------------------------------------------- |
| doc     | 获取对一个记录的引用，返回Document对象                              |
| add     | 在集合上新增记录                                                    |
| where   | 构建一个在当前集合上的查询条件，返回Query，查询条件中可使用查询指令 |
| orderBy | 指定查询数据的排序方式                                              |
| limit   | 指定返回数据的数量上限                                              |
| skip    | 指定查询时从选中的记录列表中的第几项之后开始返回                    |
| field   | 指定返回结果后每条记录应包含的字段                                  |

## 记录/文档

记录/文档对象API

| API    | 说明                           |
| ------ | ------------------------------ |
| get    | 获取记录数据                   |
| update | 局部更新数据                   |
| set    | 替换更新记录                   |
| remove | 删除记录                       |
| field  | 指定返回结果中记录应包含的字段 |

## 查询指令

Command对象查询指令

| 类别     | 指令                         | 说明                                                                 |
| -------- | ---------------------------- | -------------------------------------------------------------------- |
| 比较     | eq                           | 字段是否等于指定值                                                   |
|          | neq                          | 字段是否不等于指定值                                                 |
|          | lt                           | 字段是否小于指定值                                                   |
|          | lte                          | 小于或等于                                                           |
|          | gt                           | 大于                                                                 |
|          | gte                          | 大于等于                                                             |
|          | in                           | 字段值是否在指定数组中                                               |
|          | nin                          | 字段值是否不在指定数组中                                             |
| 逻辑     | and                          | 条件与                                                               |
|          | or                           | 或                                                                   |
|          | nor                          | 表示需所有条件都不满足                                               |
| 字段     | exists                       | 字段存在                                                             |
|          | mod                          | 字段值是否符合给定取模运算                                           |
| 数组     | all                          | 数组所有元素是否满足给定条件                                         |
|          | elemMatch                    | 数组是否有一个元素满足所有给定条件                                   |
|          | size                         | 数组长度是否等于给定值                                               |
| 地理位置 | geoNear                      | 找出字段值在给定点的附近的记录                                       |
|          | geoWithin<br />geoIntersects | 找出字段值在指定区域内的记录<br />找出与给定的地理位置图形相交的记录 |

## 更新指令

Command对象更新指令

| 类别 | 指令     | 说明                                   |
| ---- | -------- | -------------------------------------- |
| 字段 | set      | 设置字段为指定值                       |
|      | remove   | 删除字段                               |
|      | inc      | 原子操作，自增字段值                   |
|      | mul      | 原子操作，自乘字段值                   |
|      | min      | 如果字段值小于给定值，则设为给定值     |
|      | max      | 如果字段值大于给定值，则设为给定值     |
|      | rename   | 字段重命名                             |
| 数组 | push     | 往数组尾部增加指定值                   |
|      | pop      | 从数组尾部删除一个元素                 |
|      | shift    | 从数组头部删除一个元素                 |
|      | unshift  | 往数组头部增加指定值                   |
|      | addToSet | 原子操作，如果不存在给定元素则添加元素 |
|      | pull     | 剔除数组中所有满足给定条件的元素       |
|      | pullAll  | 剔除数组中所有等于给定值的元素         |

# 3.5 云数据库操作

可以在云控制台的数据库高级操作中编写和执行数据库脚本，对数据库进行CRUD（增删改查）操作，语法同SDK数据库语法

以下介绍了集合中数据的增、删、改、查操作，这些操作是通过云开发控制台中进行演示的，而微信小程序端、云函数端和控制台对数据库操作的权限是不同的，而且能够调用的API也是不同的

微信小程序端和云函数端对数据库调用API接口的不同之处，如下表所示

| 类别         | collection（批量记录操作） |     |        |        | Document（单条记录操作） |      |        |        |
| ------------ | -------------------------- | --- | ------ | ------ | ------------------------ | ---- | ------ | ------ |
|              | get                        | add | update | remove | get                      | add  | update | remove |
| 微信小程序端 | √                         | √  | ×     | ×     | √                       | ―― | √     | √     |
| 云函数端     | √                         | √  | √     | √     | √                       | ―― | √     | √     |

## 3.5.1 增加记录

集合对象API:add

## 3.5.2 查询记录

记录和集合 get方法获取单个记录或集合中多个记录的数据

### 获取一个记录的数据

.doc(_id).get()

### 获取多个记录的数据

调用集合上的where方法来指定查询条件

.where({属性：'值'}).get()

> where方法接收一个对象参数，该对象中每个字段和它的值构成一个需满足的匹配条件，各个字段间的关系是“与”的关系，即需要满足所有匹配条件。

### 数据库查询指令

比如用and逻辑指令查询价格为3500-10000元的设备

```js
db.collection('device').where({
  price:_.gt(3500).and(_.lt(10000))
}).get()
```

除了and还可以使用or

#### 进行字段值的“或”操作

```js
db.collection('device').where({
  devicename:_.eq('万用表').or(_.eq('直流电源'))
}).get()
```

#### 进行跨字段的“或”操作

```js
db.collection('device').where(
  _.or([{
    devicename:_eq('万用表')
  },
  {
    price:69300 
  }
  ])
).get()
```

多种API复合:在云数据库集合device中导入124条数据记录之后

```js
db.collection('device').where({
  price:_.gt(1000)
})
.field({
  deviceid:true,
  price:true,
})
.orderBy('price','desc')//desc表示降序，asc表示升序
.skip(1)
.limit(120)
.get()
```

### 注意

* API（add,where,orderBy,limit,skip,field等）在调用时没有先后顺序
* 数据库中高级操作中查询的返回记录没有数量限制，而在实际开发中微信小程序端在获取集合数据时服务器一次默认并且最多返回20条记录，云函数端这个数字则是100

### 获取一个集合的数据

习惯：尽量避免一次性获取过多数据
通过limit方法来指定获取的数量，如果获取集合中所有记录的数据，很可能一个请求无法取出所有数据，需要分批次取
学了云函数之后再讲

## 3.5.3 更新数据

更新数据的两个方法

| API    | 说明                   |
| ------ | ---------------------- |
| update | 局部更新一个或多个记录 |
| set    | 替换更新一个记录       |

### 局部更新

update局部更新一个记录或一个集合中的记录，只有指定的字段会得到更新，其他字段不受影响

```js
db.collection('test').doc('orange-1')
  .update({
    data: {
      price: _.inc(10)//增加10
    }
  })
```

### 替换更新

set替换更新一条记录，意味着用传入的对象替换指定的记录

```js
db.collection('test').doc('apple-1')
.set({
  data:{
    "name":"apple"
  }
})
```

## 3.5.4 删除数据

remove()删除该条记录

```js
db.collection('test').doc('apple-1')
.remove()
```

若要删除多条记录，也可以在Server端进行操作（云函数）

## 3.5.5 正则表达式查询

可以使用JS原生正则对象或使用db.RegExp()方法来构造正则对象然后进行**字符串匹配（对于数字无法匹配）**
在查询条件中对一个字段进行正则匹配即要求该字段的值可以被给定的正则表达式匹配

* 注意正则表达式不可用于db.command内（如db.command.in)

db.RegExp()方法定义如下：

```js
function RegExp(initOptions:IInitOptions):DBRegExp
interface IInitOptions{
  regexp:string //正则表达式，字符串形式
  options:string //flags,包括 i,m,s，但前端不做强限制
}
```

Options支持i,m,s这3个flag，但JS原生正则对象构造时仅支持i,m两个flags，因此使用s这个flag必须使用db.RegExp()构造正则对象。

| flag | 说明                                                                                   |
| ---- | -------------------------------------------------------------------------------------- |
| i    | 大小写不敏感                                                                           |
| m    | 跨行匹配，让开始匹配符^或结束匹配符$除了匹配字符串的开头和结尾外，还匹配行的开头和结尾 |
| s    | 让 . 可以匹配包括换行符在内的所有字符                                                  |

```js
db.collection('test').where({//test集合中
  price:db.RegExp({//price字段
    regexp:'^138\\d{2}$',//以138开头，后面2个数字结尾，^表示匹配输入字行首，\d表示匹配数字，$表示匹配输入行尾
    options:'i',
  })
}).get()
```

* 对于匹配中文：regexp:'^[\u4e00-\u9fa5]{4}$'
  "\u4e00"和"\u9fa5"时Unicode编码，正好是中文编码的开始和结束的两个值
* 对于匹配某个字（假设为白字）为结尾的记录：regexp:'白$'

## 3.5.6 查询和更新数组元素和嵌套对象

### 普通匹配

每个<key,value>构成一个筛选条件，有多个<key,value>则表示同时满足这些条件，是“与”关系，若需要“或”关系，则可以使用[command.or]

```js
db.collection('todos').where({
	done:false,
	progress:50
}).get()
```

### 匹配记录中的嵌套字段

假设集合中有以下记录

```js
{
  "style":{
    "color":"red"
  }
}
```

匹配方法有两种

```js
//方法一
db.collection('todos').where({
  style:{
    color:'red'
  }
}).get()
//方法二
db.collection('todos').where({
  'style.color':'red'
}).get()
```

### 匹配数组

假设集合中有如下记录

```js
{
  "numbers":[10,20,30]
}
```

可以传入一个完全相同的数组来筛选

```js
db.collection('todos').where({
  numbers:[10,20,30]
}).get()
```

### 匹配数组中的元素

若要找出数组字段中数组值包含某个值的记录，可以在匹配数组字段时传入想要匹配的值。如上例子
可传入一个数组中存在的元素来筛选出所有numbers字段的值包含20的记录

```js
db.collection('todos').where({
  numbers:20
}).get()
```

### 匹配数组第n项元素

若要找出数组字段中数组的第n个元素等于某个值的记录，那么在<key,value>匹配中可以以“字段.下标”为key，目标值为value做匹配。如上例子，若要找出number字段第二项的值为20的记录，查询如下（数组下标从0开始）

```js
db.collection('todos').where({
  'numbers.1':20
}).get()
```

更新也是类似，若要更新_id为test的记录的numbers字段的第二项元素至30

```js
db.collection('todos').doc('test').update({
  data:{
    'numbers.1':30
  }
})
```

### 结合查询指令进行匹配

在对数组字段进行匹配时，也可以使用如lt，gt筛选，如上例子
查找所有numbers字段的数组值中存在包含大于25的值的记录

```js
const_=db.command
db.collection('todos').where({
  numbers:_.gt(25)
}).get()
```

### 匹配并更新数组中的元素

#### 更新数组中第一个匹配到的元素

如有如下记录

```js
{
  "_id":"doc1",
  "scores":[10,20,30]
}
{
  "_id":"doc2",
  "scores":[20,20,40]
}
```

让所有scores中的第一个20的元素更新为25，

```js
const_=db.command
db.collection('todos').where({
  scores:20
}).update({
  data:{
    'scores.$':25//字段路径.$表示更新数组字段的第一个满足查询匹配条件的元素。注意使用这种的更新时，查询条件必须包含该数组字段。
  }
})
```

若记录是对象数组则使用.$.字段路径。

##### tip

* 不支持用在数组嵌套数组
* 若用unset更新操作符，不会从数组中去除该元素，而是置为null
* 若数组元素不是对象，且查询条件用了neq、not或nin，则不能使用.$

#### 更新数组中所有匹配的元素

更新数组字段可用字段路径.$[]的表示法来更新数组字段的所有元素
如有如下记录

```js
{
  "_id":"doc1",
  "scores":{
    "math":[10,20,30]
  }
}
```

如让scores.math字段中所有数字加10

```js
const_=db.command
db.collection('todos').doc('doc1').update({
  data:{
    'scores.math.$[]':_.inc(10)
  }
})
```

对于对象数组也是可以的

#### 匹配多重嵌套的数组和对象

上述所有规则都可以嵌套使用
若有如下记录

```js
{
  "root":{
    "objects":[
      {
        "numbers":[10,20,30]
      },
      {
        "numbers":[50,60,70]
      }
    ]
  }
}
```

找出集合中所有满足root.objects字段数组的第二项的numbers字段的第三项等于70的记录

```js
db.collection('todos').where({
  'root.objects.1.numbers.2':70//索引从0开始
}).get()
```

指定下标不是必需的。比如找出集合中所有满足root.objects字段数组中任意一项的numbers字段包括30的记录

```js
db.collection('todos').where({
  'root.objects.numbers':30
}).get()
```

更新操作也是如此，例如要更新_id为test的root.objects字段数组的第二项的numbers字段的第三项80

```js
db.collection('todos').doc('test').update({
  data:{
    'root.objects.1.numbers.2':80
  },
})
```
